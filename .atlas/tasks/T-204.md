---
id: T-204
type: task
status: todo
priority: high
parent_spec: 002-matchmaker-service.md
---

# Matcher Goroutine - Background Matchmaking Logic

Implement the background goroutine that continuously monitors queues and creates matches when conditions are met.

## Sub-tasks:

- [x] **Define Matcher struct** (`internal/queue/matcher.go`):
  - Reference to QueueManager
  - `stopChan` (chan struct{}): Channel to signal shutdown
  - `matchInterval` (time.Duration): How often to check for matches

- [x] **Implement NewMatcher(qm *QueueManager) *Matcher**: Constructor

- [x] **Implement Start() method**:
  - Launch goroutine that runs matching loop
  - Use ticker for periodic matching attempts
  - Listen on stopChan for graceful shutdown

- [x] **Implement Stop() method**:
  - Close stopChan to signal goroutine to exit
  - Allow graceful shutdown

- [x] **Implement tryMatch() method** (core matching logic):
  - Acquire write lock on QueueManager
  - Check if `len(survivorQueue) >= 4` AND `len(killerQueue) >= 1`
  - If conditions met:
    - Pop first 4 survivors from survivorQueue
    - Pop first 1 killer from killerQueue
    - Generate unique match ID (UUID)
    - Create Match struct with survivors and killer
    - Store match in matches map
    - Update ticketToMatch for all 5 players' tickets
    - Remove matched players from ticketToPosition
  - Release lock
  - Log match creation for debugging

- [x] **Implement position recalculation**:
  - After each match, update ticketToPosition for remaining players
  - Positions should reflect new queue order

- [x] **Add configurable match interval**: Allow setting how frequently the matcher checks (default: 100ms)
