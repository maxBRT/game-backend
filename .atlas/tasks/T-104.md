---
id: T-104
type: task
status: todo
priority: medium
parent_spec: 001-player-service.md
---

# Implement Store Purchase Endpoint

Create the POST /api/store/buy endpoint with full transactional support for item purchases.

## Sub-tasks:

- [x] **Create request/response DTOs**: Create DTOs for `BuyRequest` (playerId, itemId, quantity) and `BuyResponse` (success, newBalance, item)
- [x] **Create StoreService**: Create `Services/StoreService.cs` with a `BuyItem` method implementing the transaction flow
- [x] **Implement transaction logic**: Within a database transaction: (1) check player balance, (2) verify item exists, (3) deduct currency, (4) add/update inventory, (5) commit or rollback
- [x] **Handle error cases**: Return appropriate errors for: player not found, item not found, insufficient balance
- [x] **Create StoreController**: Create `Controllers/StoreController.cs` with POST buy endpoint
- [x] **Register StoreService**: Register `StoreService` in dependency injection
- [x] **Test transaction**: Verify successful purchase updates balance and inventory; verify rollback on failure scenarios
