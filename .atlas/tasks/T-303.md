---
id: T-303
type: task
status: todo
priority: high
parent_spec: 003-benchmark-cli.md
---

# Matchmaker Client

Implement the HTTP client for interacting with the matchmaker service's join and status endpoints.

## Sub-tasks:

- [x] **Create MatchClient struct**: Define struct in `internal/client/match.go` with HTTP client and base URL fields
- [x] **Implement NewMatchClient**: Constructor that accepts config and creates an HTTP client with connection pooling enabled
- [x] **Define request/response types**: Create structs for `JoinRequest` (role field), `JoinResponse` (ticketId field), and `StatusResponse` (status, matchId fields)

---

- [x] **Implement Join method in `internal/client/join.go`**
  - Signatu
  rere: `func (c *MatchClient) Join(ctx context.Context, player PlayerInfo) (*JoinResponse, error)`
  - Build request URL: `c.config.MatchmakerServiceURL + "/match/join"`
  - Create `JoinRequest` struct with the `player` field containing `id`, `name`, and `role`
  - Serialize request body to JSON using `json.Marshal()`
  - Create `http.NewRequestWithContext(ctx, "POST", url, bytes.NewReader(body))`
  - Set header: `Content-Type: application/json`
  - Execute request with `c.client.Do(req)`
  - If status code is not 200:
    - Read response body for error message
    - Return `fmt.Errorf("join failed (status %d): %s", resp.StatusCode, body)`
  - Deserialize response body into `JoinResponse` using `json.NewDecoder(resp.Body).Decode()`
  - Return `(*JoinResponse, nil)` on success

---

- [x] **Implement Status method in `internal/client/status.go`**
  - Signature: `func (c *MatchClient) Status(ctx context.Context, ticketID string) (*StatusResponse, error)`
  - Build request URL: `c.config.MatchmakerServiceURL + "/match/status"` (no path parameter)
  - Create `http.NewRequestWithContext(ctx, "GET", url, nil)`
  - **Critical**: Set header `TicketID: <ticketID>` (the server reads ticketID from header, not URL path)
  - Execute request with `c.client.Do(req)`
  - If status code is 400: return `ErrInvalidTicket` (custom error for unknown/invalid ticket)
  - If status code is not 200: return `fmt.Errorf("status check failed (status %d): %s", resp.StatusCode, body)`
  - Deserialize response into `StatusResponse`
  - Note: Server uses long-polling internally, but client just receives final response when ready
  - Return `(*StatusResponse, nil)` on success

---

- [x] **Define custom error types in `internal/client/errors.go`**
  - `var ErrInvalidTicket = errors.New("invalid or unknown ticket ID")`
  - `var ErrPlayerFieldsMissing = errors.New("player id, name, and role are required")`
  - `var ErrInvalidRole = errors.New("player role must be either survivor or killer")`
  - `type APIError struct { StatusCode int; Message string }` with `Error() string` method
  - Helper function: `func isRetryableError(err error) bool` - returns true for timeouts, connection refused, 5xx errors

---

- [x] **Add context cancellation support**
  - All HTTP requests must be created with `http.NewRequestWithContext(ctx, ...)` (already specified above)
  - In `Join()`: check `ctx.Err()` before making request, return early if already cancelled
  - In `Status()`: check `ctx.Err()` before making request, return early if already cancelled
  - Ensure `resp.Body.Close()` is deferred immediately after successful `client.Do()` call
  - When `ctx.Done()` fires during request, `client.Do()` returns `context.Canceled` or `context.DeadlineExceeded`

---

- [x] **Write unit tests in `internal/client/match_client_test.go`**
  - Use `httptest.NewServer` to mock the matchmaker service
  - Test `Join()` success case: returns valid `JoinResponse` with ticketID
  - Test `Join()` with missing player fields: returns appropriate error
  - Test `Join()` with invalid role: returns appropriate error
  - Test `Status()` success case with "waiting" status: returns `StatusResponse` with queue position
  - Test `Status()` success case with "matched" status: returns `StatusResponse` with matchID, survivors, killer
  - Test `Status()` with invalid ticketID: returns `ErrInvalidTicket`
  - Test context cancellation: verify requests abort when context is cancelled
