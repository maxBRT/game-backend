---
id: T-203
type: task
status: todo
priority: high
parent_spec: 002-matchmaker-service.md
---

# Queue Implementation - Thread-Safe Player Queues

Implement the queue data structure that manages survivor and killer queues with thread-safe operations.

## Sub-tasks:

- [x] **Define Queue interface** (`internal/queue/queue.go`):
  ```go
  type Queue interface {
      Enqueue(player Player) (position int)
      Dequeue() (Player, bool)
      Len() int
      Peek(n int) []Player
      Remove(ticketID string) bool
      GetPosition(ticketID string) (int, bool)
  }
  ```

- [x] **Implement InMemoryQueue struct** (`internal/queue/memory_queue.go`):
  - `players` ([]Player): Slice holding queued players
  - `ticketIndex` (map[string]int): Map ticketID to slice index for O(1) lookup
  - `mu` (sync.RWMutex): Mutex for thread-safe access
  - Implements the Queue interface

- [x] **Implement InMemoryQueue methods**:
  - `Enqueue(player Player) int`: Append player, update ticketIndex, return position
  - `Dequeue() (Player, bool)`: Pop first player, reindex remaining tickets
  - `Len() int`: Return current queue length
  - `Peek(n int) []Player`: Return first n players without removing
  - `Remove(ticketID string) bool`: Remove by ticket, reindex remaining
  - `GetPosition(ticketID string) (int, bool)`: Lookup position via ticketIndex

- [x] **Implement NewInMemoryQueue() Queue**: Constructor returning the interface type

- [x] **Define MatchStore struct** (`internal/queue/store.go`):
  - `matches` (map[string]*Match): Map of matchID to Match
  - `ticketToMatch` (map[string]string): Map ticketID to matchID
  - `mu` (sync.RWMutex): Mutex for thread-safe access

- [x] **Implement MatchStore methods**:
  - `StoreMatch(match *Match, ticketIDs []string)`: Save match and link all tickets
  - `GetMatchByTicket(ticketID string) (*Match, bool)`: Lookup match by ticket

- [x] **Define QueueManager struct** (`internal/queue/manager.go`):
  - `survivorQueue` (Queue): Interface for survivor queue
  - `killerQueue` (Queue): Interface for killer queue
  - `matchStore` (*MatchStore): Match storage
  - Uses dependency injection for queues (testability)

- [x] **Implement QueueManager methods**:
  - `NewQueueManager(survivorQ, killerQ Queue, store *MatchStore)`: Constructor with DI
  - `AddPlayer(player Player) (ticketID string, position int)`: Route to correct queue
  - `GetStatus(ticketID string) (matched bool, position int, match *Match)`: Check status

- [ ] **Add UUID generation**: Import `github.com/google/uuid` for ticket/match IDs
